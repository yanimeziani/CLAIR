name: Deploy to Dev Server with DB Reset

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run linter
      run: npm run lint || true
    
    - name: Build application
      env:
        MONGODB_URI: mongodb://localhost:27017/test
        AI_BACKEND_URL: http://localhost:8001
      run: npm run build

  deploy:
    needs: test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Clean workspace
      run: |
        rm -rf .git || true
        rm -rf * || true
        rm -rf .[!.]* || true
        git config --global --add safe.directory ${{ github.workspace }}
    
    - uses: actions/checkout@v4
      with:
        clean: true
        fetch-depth: 1
    
    - name: Create environment file
      run: |
        cat > .env.production << EOF
        NODE_ENV=production
        MONGODB_URI=mongodb://admin:securepassword@mongodb:27017/irielle?authSource=admin
        AI_BACKEND_URL=http://ai-backend:8000
        NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
        NEXTAUTH_URL=http://89.116.170.202:3000
        EOF
    
    - name: Stop existing services and preserve SSL certificates
      run: |
        echo "ğŸ›‘ Stopping existing services..."
        docker-compose down --remove-orphans || true
        
        echo "ğŸ”’ Preserving SSL certificates and selected volumes..."
        # Keep certbot_data and certbot_www volumes for SSL persistence
        
        echo "âš ï¸  Removing database volumes for fresh reset (DEV SERVER)..."
        docker volume rm irielle-platform_mongodb_data 2>/dev/null || true
        docker volume rm irielle-platform_chromadb_data 2>/dev/null || true
        
        echo "ğŸ§¹ Cleaning Docker system..."
        docker system prune -f || true
    
    - name: Build and start MongoDB first
      run: |
        echo "ğŸ”¨ Building fresh Docker images..."
        docker-compose build --no-cache
        
        echo "ğŸ—„ï¸  Starting MongoDB service..."
        docker-compose up -d mongodb
        
    - name: Wait for MongoDB and seed database
      run: |
        echo "â³ Waiting for MongoDB to be ready..."
        sleep 15
        
        # Verify MongoDB is responding with timeout
        timeout=60
        while [ $timeout -gt 0 ]; do
          if docker exec irielle-mongodb mongosh --quiet -u admin -p securepassword --authenticationDatabase admin --eval "db.adminCommand('ping')" >/dev/null 2>&1; then
            echo "âœ… MongoDB is ready"
            break
          fi
          echo "Waiting for MongoDB... ($timeout seconds remaining)"
          sleep 5
          timeout=$((timeout-5))
        done
        
        if [ $timeout -le 0 ]; then
          echo "âŒ MongoDB failed to start in time"
          docker-compose logs mongodb
          exit 1
        fi
        
        # Seed the database with fresh data
        echo "ğŸŒ± Seeding database with fresh demo data..."
        docker exec irielle-mongodb mongosh --quiet /docker-entrypoint-initdb.d/02-seed-data.js
        echo "âœ… Database seeded successfully with reset credentials"
    
    - name: Check SSL certificates and configure Nginx
      run: |
        # Make scripts executable
        chmod +x scripts/*.sh 2>/dev/null || true
        
        # Check if SSL certificates exist
        if docker volume inspect irielle_certbot_data >/dev/null 2>&1; then
          if docker run --rm -v irielle_certbot_data:/etc/letsencrypt alpine ls -la /etc/letsencrypt/live/dev.meziani.org/fullchain.pem 2>/dev/null; then
            echo "ğŸ”’ SSL certificates found, using HTTPS configuration"
            cp nginx/conf.d/irielle-ssl.conf nginx/conf.d/default.conf
            SSL_EXISTS=true
          else
            echo "ğŸŒ No SSL certificates, using HTTP configuration"
            cp nginx/conf.d/irielle.conf nginx/conf.d/default.conf
            SSL_EXISTS=false
          fi
        else
          echo "ğŸŒ No SSL volume, using HTTP configuration"
          cp nginx/conf.d/irielle.conf nginx/conf.d/default.conf
          SSL_EXISTS=false
        fi
        echo "SSL_EXISTS=$SSL_EXISTS" >> $GITHUB_ENV
        
    - name: Start all other services
      run: |
        echo "ğŸš€ Starting core services first..."
        docker-compose up -d --build frontend ai-backend chromadb ollama
        
        echo "â³ Waiting for core services to be ready..."
        sleep 20
        
        # Start nginx after other services are ready
        echo "ğŸŒ Starting Nginx..."
        docker-compose up -d nginx
        
        echo "â³ Waiting for final services..."
        sleep 10
        
    - name: Initialize SSL certificates if needed
      if: env.SSL_EXISTS == 'false'
      run: |
        echo "ğŸ” Initializing SSL certificates..."
        if [ -f "scripts/init-ssl.sh" ]; then
          ./scripts/init-ssl.sh
        else
          echo "âš ï¸  SSL initialization script not found, continuing with HTTP"
        fi
        
    - name: Initialize Ollama model
      run: |
        echo "ğŸ¤– Initializing Ollama AI model..."
        sleep 10
        docker exec irielle-ollama ollama pull gemma3:4b || echo "Model pull failed, will retry later"
        
    - name: Verify deployment and show status
      run: |
        echo "ğŸ” Verifying deployment..."
        sleep 10
        
        # Show service status
        echo ""
        echo "=== ğŸ“Š Container Status ==="
        docker-compose ps
        
        echo ""
        echo "=== ğŸ“‹ Service Health Check ==="
        
        # Test MongoDB
        if docker exec irielle-mongodb mongosh --quiet -u admin -p securepassword --authenticationDatabase admin --eval "db.adminCommand('ping')" >/dev/null 2>&1; then
          echo "âœ… MongoDB: Running"
        else
          echo "âŒ MongoDB: Failed"
        fi
        
        # Test Application
        timeout=120
        while [ $timeout -gt 0 ]; do
          if curl -f http://localhost:3000 >/dev/null 2>&1; then
            echo "âœ… Application: Running and responding"
            break
          fi
          echo "â³ Waiting for application... ($timeout seconds remaining)"
          sleep 5
          timeout=$((timeout-5))
        done
        
        if [ $timeout -le 0 ]; then
          echo "âŒ Application failed to respond in time"
          echo "=== Application Logs ==="
          docker-compose logs --tail=50 frontend
          exit 1
        fi
        
        # Check and fix Nginx if needed
        if ! docker ps | grep irielle-nginx | grep -q "Up"; then
          echo "âš ï¸  Nginx not running properly, attempting restart..."
          docker-compose restart nginx
          sleep 5
        fi
        
        # Test AI Backend
        if curl -f http://localhost:8001/health >/dev/null 2>&1; then
          echo "âœ… AI Backend: Running"
        else
          echo "âš ï¸  AI Backend: Not responding (may still be starting)"
        fi
        
        echo ""
        echo "ğŸ‰ ============================================="
        echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "ğŸ‰ ============================================="
        echo ""
        echo "ğŸ” LOGIN CREDENTIALS (FRESH RESET):"
        echo "   ğŸ‘‘ Admin PIN: 1234"
        echo "   ğŸ‘¥ Staff PIN: 5678"
        echo ""
        echo "ğŸŒ ACCESS URLS:"
        echo "   ğŸ”— Production: http://89.116.170.202:3000"
        echo "   ğŸ  Local: http://localhost:3000"
        echo ""
        echo "ğŸ“Š FRESH DATA AVAILABLE:"
        echo "   ğŸ‘¤ 5 Users (1 admin, 4 staff)"
        echo "   ğŸ¥ 5 Patients with complete medical records"
        echo "   ğŸ“‹ 3 Daily reports"
        echo "   ğŸ’¬ 4 Team communications"
        echo "   ğŸ“ˆ Bristol tracking entries"
        echo ""
        echo "âš ï¸  Database reset completed - all data is fresh for demo!"
        echo "============================================="