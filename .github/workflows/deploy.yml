name: Deploy CLAIR Healthcare System

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Pre-checkout cleanup
      run: |
        # Force cleanup of any existing files with Docker-created permissions
        find ${{ github.workspace }} -type d -exec chmod 755 {} \; 2>/dev/null || true
        find ${{ github.workspace }} -type f -exec chmod 644 {} \; 2>/dev/null || true
        rm -rf ${{ github.workspace }} || docker run --rm -v ${{ github.workspace }}:/workspace alpine rm -rf /workspace/* 2>/dev/null || true
        mkdir -p ${{ github.workspace }}
        git config --global --add safe.directory ${{ github.workspace }}
    
    - uses: actions/checkout@v4
      with:
        clean: true
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          clair-app/package-lock.json
    
    - name: Install CLAIR dependencies
      working-directory: ./clair-app
      run: npm ci
    
    - name: Run CLAIR linter
      working-directory: ./clair-app
      run: npm run lint || true
    
    - name: Build CLAIR application
      working-directory: ./clair-app
      env:
        MONGODB_URI: mongodb://localhost:27017/test
        AI_BACKEND_URL: http://localhost:8001
      run: npm run build
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nextjs-builds
        path: |
          clair-app/.next
        retention-days: 1
        if-no-files-found: warn

  deploy:
    needs: test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && (success() || failure())
    steps:
    - name: Setup workspace for self-hosted runner
      run: |
        echo "ğŸ—ï¸  Setting up workspace for self-hosted runner..."
        
        # Define workspace directory
        WORKSPACE_DIR="/home/runner/actions-runner/_work/CLAIR/CLAIR"
        
        # Create workspace directory structure if it doesn't exist
        mkdir -p "$(dirname "$WORKSPACE_DIR")"
        mkdir -p "$WORKSPACE_DIR"
        
        # Set proper ownership and permissions
        sudo chown -R runner:runner /home/runner/actions-runner/_work/ 2>/dev/null || true
        
        # Navigate to workspace
        cd "$WORKSPACE_DIR"
        
        # Clean up any existing files
        rm -rf ./* 2>/dev/null || true
        rm -rf ./.* 2>/dev/null || true
        
        # Configure git for this workspace
        git config --global --add safe.directory "$WORKSPACE_DIR"
        git config --global user.email "runner@srv723879.hstgr.cloud"
        git config --global user.name "GitHub Actions Runner"
        
        echo "âœ… Workspace setup completed: $WORKSPACE_DIR"
    
    - uses: actions/checkout@v4
      with:
        clean: true
        fetch-depth: 1
    
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: nextjs-builds
        path: .
      continue-on-error: true
      
    - name: Verify and organize downloaded artifacts
      run: |
        echo "Checking downloaded artifacts..."
        find . -name ".next" -type d | while read dir; do
          echo "Found .next directory: $dir"
          echo "Size: $(du -sh "$dir" | cut -f1)"
          echo "Contents: $(ls -la "$dir" | head -5)"
        done
        
        # Ensure .next directories are in correct locations
        if [ -d ".next" ]; then
          echo "Found .next in root, checking if it belongs to clair-app..."
          if [ ! -d "clair-app/.next" ] && [ -f "clair-app/package.json" ]; then
            echo "Moving .next to clair-app/"
            mv .next clair-app/
          fi
        fi
    
    - name: Check for build artifacts
      run: |
        echo "Checking for build artifacts..."
        
        if [ -d "clair-app/.next" ] && [ -f "clair-app/.next/BUILD_ID" ]; then
          echo "âœ… CLAIR build found ($(du -sh clair-app/.next | cut -f1))"
          echo "Using cached builds from test phase"
        else
          echo "âŒ CLAIR build not found, will build from source"
          echo "NEED_FRESH_BUILD=true" >> $GITHUB_ENV
        fi
    
    - name: Create environment file
      run: |
        cat > .env.production << EOF
        NODE_ENV=production
        MONGODB_URI=mongodb://admin:securepassword@mongodb:27017/clair?authSource=admin
        AI_BACKEND_URL=http://ai-backend:8000
        NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
        NEXTAUTH_URL=https://dev.meziani.org
        NEXT_PUBLIC_APP_URL=https://dev.meziani.org
        EOF
    
    - name: Graceful service shutdown with SSL preservation
      run: |
        echo "ğŸ›‘ Gracefully stopping and removing services..."
        
        # Ensure we're in the right directory
        cd ${{ github.workspace }}
        
        # Check if docker-compose.yml exists
        if [ ! -f "docker-compose.yml" ]; then
          echo "âŒ docker-compose.yml not found in workspace"
          exit 1
        fi
        
        # Install Docker if not present
        if ! command -v docker &> /dev/null; then
          echo "ğŸ“¦ Installing Docker..."
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker runner
        fi
        
        # Install Docker Compose if not present
        if ! command -v docker-compose &> /dev/null; then
          echo "ğŸ“¦ Installing Docker Compose..."
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
        fi
        
        # Stop and remove application services but keep nginx and ollama
        docker-compose stop clair-frontend ai-backend || true
        docker-compose rm -f clair-frontend ai-backend || true
        
        echo "ğŸ”’ Preserving SSL certificates, nginx, and ollama..."
        # Keep nginx running to show maintenance mode
        # Keep ollama running to preserve models
        
        echo "ğŸ—„ï¸ Stopping and removing database services for reset..."
        docker-compose stop mongodb chromadb || true
        docker-compose rm -f mongodb chromadb || true
        
        echo "âš ï¸  Removing database volumes for fresh reset (DEV SERVER)..."
        docker volume rm clair_mongodb_data 2>/dev/null || true
        docker volume rm clair_chromadb_data 2>/dev/null || true
        
        echo "ğŸ§¹ Force cleanup any containers using ports 3000, 3001, 8001..."
        # Kill any processes using these ports
        sudo lsof -ti:3000 | xargs -r sudo kill -9 2>/dev/null || true
        sudo lsof -ti:3001 | xargs -r sudo kill -9 2>/dev/null || true
        sudo lsof -ti:8001 | xargs -r sudo kill -9 2>/dev/null || true
        
        # Remove any containers that might be using these ports
        docker ps -a --filter "expose=3000" --format "{{.ID}}" | xargs -r docker rm -f || true
        docker ps -a --filter "expose=3001" --format "{{.ID}}" | xargs -r docker rm -f || true
        docker ps -a --filter "expose=8001" --format "{{.ID}}" | xargs -r docker rm -f || true
        
        echo "ğŸ§¹ Cleaning unused Docker resources..."
        docker system prune -f || true
    
    - name: Setup Node.js
      if: env.NEED_FRESH_BUILD == 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          clair-app/package-lock.json
    
    - name: Build applications from source
      if: env.NEED_FRESH_BUILD == 'true'
      run: |
        echo "ğŸ”¨ Building applications from source..."
        
        # Install and build CLAIR
        echo "ğŸ“¦ Installing CLAIR dependencies..."
        cd clair-app
        npm ci
        echo "ğŸ”¨ Building CLAIR..."
        npm run build
        cd ..
        
        echo "âœ… Fresh builds completed"
    
    - name: Build and start database services
      run: |
        # Determine build type
        if [ -n "$NEED_FRESH_BUILD" ]; then
          echo "ğŸ”¨ Building Docker images with fresh builds..."
          BUILD_TYPE="fresh builds"
        else
          echo "ğŸ”¨ Building Docker images with cached builds..."
          BUILD_TYPE="cached builds from test phase"
          
          # Verify build artifacts are available
          if [ -d "clair-app/.next" ]; then
            echo "âœ… Using cached CLAIR build ($(du -sh clair-app/.next | cut -f1))"
          else
            echo "âŒ CLAIR build not found after download"
            exit 1
          fi
        fi
        
        # Build infrastructure services first (without cache for fresh deployment)
        echo "ğŸ—ï¸  Building infrastructure services..."
        docker-compose build --no-cache mongodb chromadb ai-backend nginx ollama certbot
        
        # Build Next.js apps with available builds
        echo "âš¡ Building Next.js containers with $BUILD_TYPE..."
        docker-compose build clair-frontend
        
        echo "âœ… All Docker images built successfully"
        
        # Show build performance summary
        echo ""
        echo "=== âš¡ Build Performance Summary ==="
        if [ -n "$NEED_FRESH_BUILD" ]; then
          echo "ğŸ“Š Built from source due to missing artifacts"
        else
          echo "ğŸ“Š Next.js builds reused from test phase - significantly faster deployment!"
          echo "ğŸ“Š CLAIR build size: $(du -sh clair-app/.next | cut -f1)"
        fi
        echo "ğŸ“Š Infrastructure services rebuilt for fresh deployment"
        echo "================================="
        echo ""
        
        echo "ğŸ—„ï¸  Starting database services..."
        docker-compose up -d mongodb chromadb
        
        echo "ğŸ¤– Ensuring ollama is running..."
        # Start ollama if not already running (preserve existing models)
        if ! docker ps --format "table {{.Names}}" | grep -q "clair-ollama"; then
          docker-compose up -d ollama
        fi
        
    - name: Wait for MongoDB and seed database
      run: |
        echo "â³ Waiting for MongoDB to be ready..."
        sleep 15
        
        # Verify MongoDB is responding with timeout
        timeout=60
        while [ $timeout -gt 0 ]; do
          if docker exec clair-mongodb mongosh --quiet -u admin -p securepassword --authenticationDatabase admin --eval "db.adminCommand('ping')" >/dev/null 2>&1; then
            echo "âœ… MongoDB is ready"
            break
          fi
          echo "Waiting for MongoDB... ($timeout seconds remaining)"
          sleep 5
          timeout=$((timeout-5))
        done
        
        if [ $timeout -le 0 ]; then
          echo "âŒ MongoDB failed to start in time"
          docker-compose logs mongodb
          exit 1
        fi
        
        # Seed the database with fresh data
        echo "ğŸŒ± Seeding database with fresh demo data..."
        docker exec clair-mongodb mongosh --quiet /docker-entrypoint-initdb.d/02-seed-data.js
        echo "âœ… Database seeded successfully with reset credentials"
    
    - name: Configure SSL certificates automatically
      run: |
        echo "ğŸ” Configuring SSL certificates..."
        
        # Make scripts executable
        chmod +x clair-app/scripts/*.sh 2>/dev/null || true
        
        # Ensure certbot volumes exist
        docker volume create clair_certbot_data 2>/dev/null || true
        docker volume create clair_certbot_www 2>/dev/null || true
        
        # Start with HTTP-only configuration, then switch to SSL
        echo "ğŸŒ Starting with HTTP-only configuration for certificate generation"
        
        # Ensure HTTP-only config is active initially
        if [ -f "clair-app/nginx/conf.d/irielle-ssl.conf" ]; then
          mv clair-app/nginx/conf.d/irielle-ssl.conf clair-app/nginx/conf.d/irielle-ssl.conf.disabled
        fi
        if [ -f "clair-app/nginx/conf.d/irielle-http-only.conf.disabled" ]; then
          mv clair-app/nginx/conf.d/irielle-http-only.conf.disabled clair-app/nginx/conf.d/irielle-http-only.conf
        fi
        
        # Check if SSL certificates exist
        if docker run --rm -v clair_certbot_data:/etc/letsencrypt alpine ls -la /etc/letsencrypt/live/dev.meziani.org/fullchain.pem 2>/dev/null; then
          echo "ğŸ”’ SSL certificates found"
          SSL_EXISTS=true
        else
          echo "ğŸ” No SSL certificates found, will generate them"
          SSL_EXISTS=false
        fi
        echo "SSL_EXISTS=$SSL_EXISTS" >> $GITHUB_ENV
        
    - name: Start application services
      run: |
        echo "ğŸ” Final port check before starting services..."
        netstat -tulpn | grep ":300[01]" || echo "Ports 3000/3001 are free"
        
        echo "ğŸš€ Starting application services with pre-built images..."
        # Force remove any existing containers with same names
        docker rm -f clair-frontend clair-ai-backend 2>/dev/null || true
        
        # Start services individually to catch any port conflicts (no rebuild needed)
        echo "Starting CLAIR frontend with cached build..."
        docker-compose up -d clair-frontend
        sleep 10
        
        echo "Starting AI backend..."
        docker-compose up -d ai-backend
        sleep 10
        
        echo "â³ Waiting for application services to be ready..."
        sleep 20
        
        # Restart nginx to pick up new services (preserves SSL)
        echo "ğŸŒ Restarting Nginx to connect to new services..."
        docker-compose restart nginx
        
        echo "â³ Waiting for final services..."
        sleep 10
        
    - name: Generate SSL certificates and configure HTTPS
      run: |
        echo "ğŸ” Generating SSL certificates and configuring HTTPS..."
        
        # Wait for nginx to be ready
        echo "â³ Waiting for nginx to be ready..."
        sleep 15
        
        # Test HTTP access first
        echo "ğŸŒ Testing HTTP access..."
        if ! curl -f http://dev.meziani.org >/dev/null 2>&1; then
          echo "âŒ HTTP access not working, checking nginx logs..."
          docker-compose logs nginx
          exit 1
        fi
        echo "âœ… HTTP access working"
        
        # Generate SSL certificates if they don't exist
        if [ "$SSL_EXISTS" == "false" ]; then
          echo "ğŸš€ Generating SSL certificates..."
          
          # Generate certificate for main domain
          docker-compose run --rm certbot certonly \
            --webroot \
            --webroot-path=/var/www/certbot \
            --email support@meziani.org \
            --agree-tos \
            --no-eff-email \
            --force-renewal \
            -d dev.meziani.org
          
          if [ $? -eq 0 ]; then
            echo "âœ… SSL certificates generated successfully"
            SSL_EXISTS=true
          else
            echo "âŒ SSL certificate generation failed"
            exit 1
          fi
        fi
        
        # Switch to SSL configuration
        if [ "$SSL_EXISTS" == "true" ]; then
          echo "ğŸ”„ Switching to SSL configuration..."
          
          # Disable HTTP-only config
          if [ -f "clair-app/nginx/conf.d/irielle-http-only.conf" ]; then
            mv clair-app/nginx/conf.d/irielle-http-only.conf clair-app/nginx/conf.d/irielle-http-only.conf.disabled
          fi
          
          # Enable SSL config
          if [ -f "clair-app/nginx/conf.d/irielle-ssl.conf.disabled" ]; then
            mv clair-app/nginx/conf.d/irielle-ssl.conf.disabled clair-app/nginx/conf.d/irielle-ssl.conf
          fi
          
          # Verify SSL certificate includes subdomain
          echo "ğŸ” Verifying SSL certificate includes both domains..."
          docker run --rm -v clair_certbot_data:/etc/letsencrypt alpine \
            openssl x509 -in /etc/letsencrypt/live/dev.meziani.org/fullchain.pem -text -noout | grep -E "DNS:" || echo "Certificate domains check failed"
          
          # Restart nginx with SSL configuration
          echo "ğŸ”„ Restarting nginx with SSL configuration..."
          docker-compose restart nginx
          sleep 20
          
          # Test HTTPS access for both domains
          echo "ğŸ” Testing HTTPS access for dev.meziani.org..."
          MAIN_SSL_OK=false
          for i in {1..5}; do
            if curl -f -k https://dev.meziani.org >/dev/null 2>&1; then
              echo "âœ… dev.meziani.org HTTPS is working!"
              MAIN_SSL_OK=true
              break
            else
              echo "â³ dev.meziani.org HTTPS test attempt $i failed, retrying..."
              sleep 10
            fi
          done
          
          if [ "$MAIN_SSL_OK" == "true" ]; then
            echo "SSL_WORKING=true" >> $GITHUB_ENV
          else
            echo "âŒ SSL not working for domain"
            echo "Main domain SSL: $MAIN_SSL_OK"
            echo "Checking nginx logs..."
            docker-compose logs nginx
            echo "SSL_WORKING=false" >> $GITHUB_ENV
          fi
        else
          echo "SSL_WORKING=false" >> $GITHUB_ENV
        fi
        
    - name: Initialize Ollama model
      run: |
        echo "ğŸ¤– Checking Ollama AI model..."
        sleep 10
        # Check if model already exists, only pull if missing
        if ! docker exec clair-ollama ollama list | grep -q "gemma3:4b"; then
          echo "Model not found, pulling gemma3:4b..."
          docker exec clair-ollama ollama pull gemma3:4b || echo "Model pull failed, will retry later"
        else
          echo "Model gemma3:4b already exists, skipping pull"
        fi
        
    - name: Verify deployment and show status
      run: |
        echo "ğŸ” Verifying deployment..."
        sleep 10
        
        # Show service status
        echo ""
        echo "=== ğŸ“Š Container Status ==="
        docker-compose ps
        
        echo ""
        echo "=== ğŸ“‹ Service Health Check ==="
        
        # Test MongoDB
        if docker exec clair-mongodb mongosh --quiet -u admin -p securepassword --authenticationDatabase admin --eval "db.adminCommand('ping')" >/dev/null 2>&1; then
          echo "âœ… MongoDB: Running"
        else
          echo "âŒ MongoDB: Failed"
        fi
        
        # Test CLAIR Application
        timeout=120
        while [ $timeout -gt 0 ]; do
          if curl -f http://localhost:3000 >/dev/null 2>&1; then
            echo "âœ… CLAIR Application: Running and responding"
            break
          fi
          echo "â³ Waiting for CLAIR application... ($timeout seconds remaining)"
          sleep 5
          timeout=$((timeout-5))
        done
        
        if [ $timeout -le 0 ]; then
          echo "âŒ CLAIR Application failed to respond in time"
          echo "=== CLAIR Application Logs ==="
          docker-compose logs --tail=50 clair-frontend
          exit 1
        fi
        
        
        # Check and fix Nginx if needed
        if ! docker ps | grep clair-nginx | grep -q "Up"; then
          echo "âš ï¸  Nginx not running properly, attempting restart..."
          docker-compose restart nginx
          sleep 5
        fi
        
        # Test AI Backend
        if curl -f http://localhost:8001/health >/dev/null 2>&1; then
          echo "âœ… AI Backend: Running"
        else
          echo "âš ï¸  AI Backend: Not responding (may still be starting)"
        fi
        
        echo ""
        echo "ğŸ‰ ============================================="
        echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "ğŸ‰ ============================================="
        echo ""
        echo "ğŸ” LOGIN CREDENTIALS (FRESH RESET):"
        echo "   ğŸ‘‘ Admin PIN: 1234"
        echo "   ğŸ‘¥ Staff PIN: 5678"
        echo ""
        echo "ğŸŒ ACCESS URLS:"
        if [ "$SSL_WORKING" == "true" ]; then
          echo "   ğŸ¥ CLAIR Healthcare: https://dev.meziani.org (SSL ENABLED âœ…)"
          echo "   ğŸ”— Direct CLAIR: http://89.116.170.202:3000"
        else
          echo "   âŒ CLAIR Healthcare: https://dev.meziani.org (SSL FAILED)"
          echo "   ğŸ”— HTTP CLAIR: http://dev.meziani.org (if available)"
          echo "   ğŸ”— Direct CLAIR: http://89.116.170.202:3000"
        fi
        echo "   ğŸ  Local CLAIR: http://localhost:3000"
        echo ""
        echo "ğŸ“Š FRESH DATA AVAILABLE:"
        echo "   ğŸ‘¤ 5 Users (1 admin, 4 staff)"
        echo "   ğŸ¥ 5 Patients with complete medical records"
        echo "   ğŸ“‹ 3 Daily reports"
        echo "   ğŸ’¬ 4 Team communications"
        echo "   ğŸ“ˆ Bristol tracking entries"
        echo "   ğŸ“Š Integrated analytics dashboard"
        echo ""
        echo "âš ï¸  Database reset completed - all data is fresh for demo!"
        echo "============================================="
        
    - name: Final restart
      run: |
        echo "ğŸ”„ Final restart to ensure everything is running smoothly..."
        docker-compose restart clair-frontend nginx