name: Deploy CLAIR Healthcare System with LUCIDE Analytics

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: |
          clair-app/package-lock.json
          lucide-analytics/package-lock.json
    
    - name: Install CLAIR dependencies
      working-directory: ./clair-app
      run: npm ci
    
    - name: Install LUCIDE dependencies
      working-directory: ./lucide-analytics
      run: npm ci
    
    - name: Run CLAIR linter
      working-directory: ./clair-app
      run: npm run lint || true
    
    - name: Run LUCIDE linter
      working-directory: ./lucide-analytics
      run: npm run lint || true
    
    - name: Build CLAIR application
      working-directory: ./clair-app
      env:
        MONGODB_URI: mongodb://localhost:27017/test
        AI_BACKEND_URL: http://localhost:8001
      run: npm run build
    
    - name: Build LUCIDE application
      working-directory: ./lucide-analytics
      run: npm run build

  deploy:
    needs: test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Clean workspace
      run: |
        rm -rf .git || true
        rm -rf * || true
        rm -rf .[!.]* || true
        git config --global --add safe.directory ${{ github.workspace }}
    
    - uses: actions/checkout@v4
      with:
        clean: true
        fetch-depth: 1
    
    - name: Create environment file
      run: |
        cat > .env.production << EOF
        NODE_ENV=production
        MONGODB_URI=mongodb://admin:securepassword@mongodb:27017/irielle?authSource=admin
        AI_BACKEND_URL=http://ai-backend:8000
        NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
        NEXTAUTH_URL=https://dev.meziani.org
        NEXT_PUBLIC_APP_URL=https://dev.meziani.org
        EOF
    
    - name: Graceful service shutdown with SSL preservation
      run: |
        echo "üõë Gracefully stopping services..."
        
        # Stop application services but keep nginx and ollama
        docker-compose stop clair-frontend lucide-analytics ai-backend || true
        
        echo "üîí Preserving SSL certificates, nginx, and ollama..."
        # Keep nginx running to show maintenance mode
        # Keep ollama running to preserve models
        
        echo "üóÑÔ∏è Stopping database services for reset..."
        docker-compose stop mongodb chromadb || true
        
        echo "‚ö†Ô∏è  Removing database volumes for fresh reset (DEV SERVER)..."
        docker volume rm clair_mongodb_data 2>/dev/null || true
        docker volume rm clair_chromadb_data 2>/dev/null || true
        
        echo "üßπ Cleaning unused Docker resources..."
        docker system prune -f || true
    
    - name: Build and start database services
      run: |
        echo "üî® Building fresh Docker images..."
        docker-compose build --no-cache
        
        echo "üóÑÔ∏è  Starting database services..."
        docker-compose up -d mongodb chromadb
        
        echo "ü§ñ Ensuring ollama is running..."
        # Start ollama if not already running (preserve existing models)
        if ! docker ps --format "table {{.Names}}" | grep -q "irielle-ollama"; then
          docker-compose up -d ollama
        fi
        
    - name: Wait for MongoDB and seed database
      run: |
        echo "‚è≥ Waiting for MongoDB to be ready..."
        sleep 15
        
        # Verify MongoDB is responding with timeout
        timeout=60
        while [ $timeout -gt 0 ]; do
          if docker exec irielle-mongodb mongosh --quiet -u admin -p securepassword --authenticationDatabase admin --eval "db.adminCommand('ping')" >/dev/null 2>&1; then
            echo "‚úÖ MongoDB is ready"
            break
          fi
          echo "Waiting for MongoDB... ($timeout seconds remaining)"
          sleep 5
          timeout=$((timeout-5))
        done
        
        if [ $timeout -le 0 ]; then
          echo "‚ùå MongoDB failed to start in time"
          docker-compose logs mongodb
          exit 1
        fi
        
        # Seed the database with fresh data
        echo "üå± Seeding database with fresh demo data..."
        docker exec irielle-mongodb mongosh --quiet /docker-entrypoint-initdb.d/02-seed-data.js
        echo "‚úÖ Database seeded successfully with reset credentials"
    
    - name: Configure SSL certificates automatically
      run: |
        echo "üîê Configuring SSL certificates..."
        
        # Make scripts executable
        chmod +x clair-app/scripts/*.sh 2>/dev/null || true
        
        # Ensure certbot volumes exist
        docker volume create clair_certbot_data 2>/dev/null || true
        docker volume create clair_certbot_www 2>/dev/null || true
        
        # Start with HTTP-only configuration, then switch to SSL
        echo "üåê Starting with HTTP-only configuration for certificate generation"
        
        # Ensure HTTP-only config is active initially
        if [ -f "nginx/conf.d/irielle-ssl.conf" ]; then
          mv nginx/conf.d/irielle-ssl.conf nginx/conf.d/irielle-ssl.conf.disabled
        fi
        if [ -f "nginx/conf.d/irielle-http-only.conf.disabled" ]; then
          mv nginx/conf.d/irielle-http-only.conf.disabled nginx/conf.d/irielle-http-only.conf
        fi
        
        # Check if SSL certificates exist
        if docker run --rm -v clair_certbot_data:/etc/letsencrypt alpine ls -la /etc/letsencrypt/live/dev.meziani.org/fullchain.pem 2>/dev/null; then
          echo "üîí SSL certificates found"
          SSL_EXISTS=true
        else
          echo "üîê No SSL certificates found, will generate them"
          SSL_EXISTS=false
        fi
        echo "SSL_EXISTS=$SSL_EXISTS" >> $GITHUB_ENV
        
    - name: Start application services
      run: |
        echo "üöÄ Starting application services..."
        docker-compose up -d --build clair-frontend lucide-analytics ai-backend
        
        echo "‚è≥ Waiting for application services to be ready..."
        sleep 30
        
        # Restart nginx to pick up new services (preserves SSL)
        echo "üåê Restarting Nginx to connect to new services..."
        docker-compose restart nginx
        
        echo "‚è≥ Waiting for final services..."
        sleep 10
        
    - name: Generate SSL certificates and configure HTTPS
      run: |
        echo "üîê Generating SSL certificates and configuring HTTPS..."
        
        # Wait for nginx to be ready
        echo "‚è≥ Waiting for nginx to be ready..."
        sleep 15
        
        # Test HTTP access first
        echo "üåê Testing HTTP access..."
        if ! curl -f http://dev.meziani.org >/dev/null 2>&1; then
          echo "‚ùå HTTP access not working, checking nginx logs..."
          docker-compose logs nginx
          exit 1
        fi
        echo "‚úÖ HTTP access working"
        
        # Generate SSL certificates if they don't exist
        if [ "$SSL_EXISTS" == "false" ]; then
          echo "üöÄ Generating SSL certificates..."
          
          # Generate certificate
          docker-compose run --rm certbot certonly \
            --webroot \
            --webroot-path=/var/www/certbot \
            --email support@meziani.org \
            --agree-tos \
            --no-eff-email \
            --force-renewal \
            --domains dev.meziani.org
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ SSL certificates generated successfully"
            SSL_EXISTS=true
          else
            echo "‚ùå SSL certificate generation failed"
            exit 1
          fi
        fi
        
        # Switch to SSL configuration
        if [ "$SSL_EXISTS" == "true" ]; then
          echo "üîÑ Switching to SSL configuration..."
          
          # Disable HTTP-only config
          if [ -f "nginx/conf.d/irielle-http-only.conf" ]; then
            mv nginx/conf.d/irielle-http-only.conf nginx/conf.d/irielle-http-only.conf.disabled
          fi
          
          # Enable SSL config
          if [ -f "nginx/conf.d/irielle-ssl.conf.disabled" ]; then
            mv nginx/conf.d/irielle-ssl.conf.disabled nginx/conf.d/irielle-ssl.conf
          fi
          
          # Restart nginx with SSL configuration
          echo "üîÑ Restarting nginx with SSL configuration..."
          docker-compose restart nginx
          sleep 20
          
          # Test HTTPS access
          echo "üîç Testing HTTPS access..."
          for i in {1..5}; do
            if curl -f -k https://dev.meziani.org >/dev/null 2>&1; then
              echo "‚úÖ HTTPS is working correctly!"
              echo "SSL_WORKING=true" >> $GITHUB_ENV
              break
            else
              echo "‚è≥ HTTPS test attempt $i failed, retrying..."
              sleep 10
            fi
          done
          
          if [ "$SSL_WORKING" != "true" ]; then
            echo "‚ùå HTTPS still not working after 5 attempts"
            echo "Checking nginx logs..."
            docker-compose logs nginx
            echo "SSL_WORKING=false" >> $GITHUB_ENV
          fi
        else
          echo "SSL_WORKING=false" >> $GITHUB_ENV
        fi
        
    - name: Initialize Ollama model
      run: |
        echo "ü§ñ Checking Ollama AI model..."
        sleep 10
        # Check if model already exists, only pull if missing
        if ! docker exec irielle-ollama ollama list | grep -q "gemma3:4b"; then
          echo "Model not found, pulling gemma3:4b..."
          docker exec irielle-ollama ollama pull gemma3:4b || echo "Model pull failed, will retry later"
        else
          echo "Model gemma3:4b already exists, skipping pull"
        fi
        
    - name: Verify deployment and show status
      run: |
        echo "üîç Verifying deployment..."
        sleep 10
        
        # Show service status
        echo ""
        echo "=== üìä Container Status ==="
        docker-compose ps
        
        echo ""
        echo "=== üìã Service Health Check ==="
        
        # Test MongoDB
        if docker exec irielle-mongodb mongosh --quiet -u admin -p securepassword --authenticationDatabase admin --eval "db.adminCommand('ping')" >/dev/null 2>&1; then
          echo "‚úÖ MongoDB: Running"
        else
          echo "‚ùå MongoDB: Failed"
        fi
        
        # Test CLAIR Application
        timeout=120
        while [ $timeout -gt 0 ]; do
          if curl -f http://localhost:3000 >/dev/null 2>&1; then
            echo "‚úÖ CLAIR Application: Running and responding"
            break
          fi
          echo "‚è≥ Waiting for CLAIR application... ($timeout seconds remaining)"
          sleep 5
          timeout=$((timeout-5))
        done
        
        if [ $timeout -le 0 ]; then
          echo "‚ùå CLAIR Application failed to respond in time"
          echo "=== CLAIR Application Logs ==="
          docker-compose logs --tail=50 clair-frontend
          exit 1
        fi
        
        # Test LUCIDE Analytics
        timeout=60
        while [ $timeout -gt 0 ]; do
          if curl -f http://localhost:3001 >/dev/null 2>&1; then
            echo "‚úÖ LUCIDE Analytics: Running and responding"
            break
          fi
          echo "‚è≥ Waiting for LUCIDE analytics... ($timeout seconds remaining)"
          sleep 5
          timeout=$((timeout-5))
        done
        
        if [ $timeout -le 0 ]; then
          echo "‚ùå LUCIDE Analytics failed to respond in time"
          echo "=== LUCIDE Analytics Logs ==="
          docker-compose logs --tail=50 lucide-analytics
          # Don't exit here, analytics is not critical for main app
        fi
        
        # Check and fix Nginx if needed
        if ! docker ps | grep irielle-nginx | grep -q "Up"; then
          echo "‚ö†Ô∏è  Nginx not running properly, attempting restart..."
          docker-compose restart nginx
          sleep 5
        fi
        
        # Test AI Backend
        if curl -f http://localhost:8001/health >/dev/null 2>&1; then
          echo "‚úÖ AI Backend: Running"
        else
          echo "‚ö†Ô∏è  AI Backend: Not responding (may still be starting)"
        fi
        
        echo ""
        echo "üéâ ============================================="
        echo "üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "üéâ ============================================="
        echo ""
        echo "üîê LOGIN CREDENTIALS (FRESH RESET):"
        echo "   üëë Admin PIN: 1234"
        echo "   üë• Staff PIN: 5678"
        echo ""
        echo "üåê ACCESS URLS:"
        if [ "$SSL_WORKING" == "true" ]; then
          echo "   üè• CLAIR Healthcare: https://dev.meziani.org (SSL ENABLED ‚úÖ)"
          echo "   üìä LUCIDE Analytics: https://dev.meziani.org/analytics (SSL ENABLED ‚úÖ)"
          echo "   üîó Fallback CLAIR: http://89.116.170.202:3000"
          echo "   üîó Fallback LUCIDE: http://89.116.170.202:3000/analytics"
        else
          echo "   ‚ùå CLAIR Healthcare: https://dev.meziani.org (SSL FAILED)"
          echo "   ‚ùå LUCIDE Analytics: https://dev.meziani.org/analytics (SSL FAILED)"
          echo "   üîó Fallback CLAIR: http://89.116.170.202:3000"
          echo "   üîó Fallback LUCIDE: http://89.116.170.202:3000/analytics"
        fi
        echo "   üè† Local CLAIR: http://localhost:3000"
        echo "   üè† Local LUCIDE: http://localhost:3001"
        echo ""
        echo "üìä FRESH DATA AVAILABLE:"
        echo "   üë§ 5 Users (1 admin, 4 staff)"
        echo "   üè• 5 Patients with complete medical records"
        echo "   üìã 3 Daily reports"
        echo "   üí¨ 4 Team communications"
        echo "   üìà Bristol tracking entries"
        echo "   üìä Analytics dashboard with visitor tracking"
        echo ""
        echo "‚ö†Ô∏è  Database reset completed - all data is fresh for demo!"
        echo "============================================="
        
    - name: Final restart
      run: |
        echo "üîÑ Final restart to ensure everything is running smoothly..."
        docker-compose restart clair-frontend lucide-analytics nginx