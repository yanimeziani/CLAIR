name: SSL Certificate Update

on:
  workflow_dispatch:
    inputs:
      force_renewal:
        description: 'Force certificate renewal even if not needed'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-ssl:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v4
    
    - name: Update SSL certificate
      run: |
        echo "ğŸ” Updating SSL certificate for dev.meziani.org..."
        
        # Check current certificate status
        echo "ğŸ“‹ Current certificate status:"
        docker run --rm -v clair_certbot_data:/etc/letsencrypt certbot/certbot certificates
        
        # Ensure we're using HTTP-only configuration for certificate generation
        echo "ğŸŒ Switching to HTTP-only configuration for certificate update..."
        cd /actions-runner/_work/CLAIR/CLAIR
        
        # Create .env.production file if it doesn't exist
        if [ ! -f ".env.production" ]; then
          echo "ğŸ“ Creating .env.production file..."
          cat > .env.production << 'EOF'
NODE_ENV=production
MONGODB_URI=mongodb://admin:securepassword@mongodb:27017/irielle?authSource=admin
AI_BACKEND_URL=http://ai-backend:8000
NEXTAUTH_SECRET=your-nextauth-secret-key-here
NEXTAUTH_URL=https://dev.meziani.org
EOF
        fi
        
        # Disable SSL config temporarily
        if [ -f "nginx/conf.d/irielle-ssl.conf" ]; then
          mv nginx/conf.d/irielle-ssl.conf nginx/conf.d/irielle-ssl.conf.disabled
        fi
        
        # Enable HTTP-only config
        if [ -f "nginx/conf.d/irielle-http-only.conf.disabled" ]; then
          mv nginx/conf.d/irielle-http-only.conf.disabled nginx/conf.d/irielle-http-only.conf
        fi
        
        # Restart nginx with HTTP-only config
        docker-compose restart nginx
        sleep 15
        
        # Test domain is accessible via HTTP
        echo "ğŸ§ª Testing HTTP access for domain..."
        if curl -f http://dev.meziani.org >/dev/null 2>&1; then
          echo "âœ… dev.meziani.org is accessible via HTTP"
        else
          echo "âŒ dev.meziani.org is not accessible via HTTP"
          exit 1
        fi
        
        # Generate new certificate
        echo "ğŸš€ Generating new SSL certificate..."
        FORCE_FLAG="--force-renewal"
        if [ "${{ github.event.inputs.force_renewal }}" != "true" ]; then
          FORCE_FLAG="--expand"
        fi
        
        docker-compose run --rm certbot certonly \
          --webroot \
          --webroot-path=/var/www/certbot \
          --email support@meziani.org \
          --agree-tos \
          --no-eff-email \
          $FORCE_FLAG \
          -d dev.meziani.org
        
        if [ $? -eq 0 ]; then
          echo "âœ… SSL certificate generated successfully"
          
          # Verify certificate
          echo "ğŸ” Verifying certificate..."
          docker run --rm -v clair_certbot_data:/etc/letsencrypt alpine \
            openssl x509 -in /etc/letsencrypt/live/dev.meziani.org/fullchain.pem -text -noout | grep -E "DNS:" || echo "Certificate info check failed"
          
          echo "ğŸ“‹ Updated certificate status:"
          docker run --rm -v clair_certbot_data:/etc/letsencrypt certbot/certbot certificates
          
        else
          echo "âŒ SSL certificate generation failed"
          exit 1
        fi
        
    - name: Switch to SSL configuration
      run: |
        echo "ğŸ”„ Switching to SSL configuration..."
        cd /actions-runner/_work/CLAIR/CLAIR
        
        # .env.production file should already exist from earlier step
        if [ ! -f ".env.production" ]; then
          echo "âš ï¸ .env.production file missing, this should not happen"
          exit 1
        fi
        
        # Disable HTTP-only config
        if [ -f "nginx/conf.d/irielle-http-only.conf" ]; then
          mv nginx/conf.d/irielle-http-only.conf nginx/conf.d/irielle-http-only.conf.disabled
        fi
        
        # Enable SSL config
        if [ -f "nginx/conf.d/irielle-ssl.conf.disabled" ]; then
          mv nginx/conf.d/irielle-ssl.conf.disabled nginx/conf.d/irielle-ssl.conf
        fi
        
        # Test nginx configuration
        echo "ğŸ§ª Testing nginx configuration..."
        if docker-compose exec nginx nginx -t 2>/dev/null; then
          echo "âœ… Nginx configuration is valid"
        else
          echo "âŒ Nginx configuration is invalid, reverting..."
          # Revert to HTTP-only config
          if [ -f "nginx/conf.d/irielle-ssl.conf" ]; then
            mv nginx/conf.d/irielle-ssl.conf nginx/conf.d/irielle-ssl.conf.disabled
          fi
          if [ -f "nginx/conf.d/irielle-http-only.conf.disabled" ]; then
            mv nginx/conf.d/irielle-http-only.conf.disabled nginx/conf.d/irielle-http-only.conf
          fi
          exit 1
        fi
        
        # Restart nginx with SSL configuration
        docker-compose restart nginx
        sleep 20
        
    - name: Test SSL functionality
      run: |
        echo "ğŸ” Testing SSL functionality..."
        
        # Test HTTPS for main domain
        echo "ğŸ§ª Testing HTTPS for dev.meziani.org..."
        for i in {1..5}; do
          if curl -f -k https://dev.meziani.org >/dev/null 2>&1; then
            echo "âœ… dev.meziani.org HTTPS is working!"
            MAIN_SSL_OK=true
            break
          else
            echo "â³ HTTPS test for dev.meziani.org attempt $i failed, retrying..."
            sleep 10
          fi
        done
        
        # Test HTTP redirects
        echo "ğŸ§ª Testing HTTP to HTTPS redirects..."
        if curl -s -o /dev/null -w "%{http_code}" http://dev.meziani.org | grep -q "30[12]"; then
          echo "âœ… HTTP redirect working for dev.meziani.org"
        else
          echo "âš ï¸ HTTP redirect might not be working for dev.meziani.org"
        fi
        
        # Final status report
        echo ""
        echo "ğŸ‰ ============================================="
        echo "ğŸ‰ SSL UPDATE COMPLETED!"
        echo "ğŸ‰ ============================================="
        echo ""
        echo "ğŸ” SSL STATUS:"
        if [ "$MAIN_SSL_OK" == "true" ]; then
          echo "   âœ… https://dev.meziani.org - SSL Working"
        else
          echo "   âŒ https://dev.meziani.org - SSL Failed"
        fi
        
        echo ""
        echo "ğŸ”’ Certificate information:"
        docker run --rm -v clair_certbot_data:/etc/letsencrypt certbot/certbot certificates
        echo "============================================="
        
        # Exit with error if domain failed
        if [ "$MAIN_SSL_OK" != "true" ]; then
          echo "âŒ SSL setup failed"
          exit 1
        fi